# Image URL Transformation

This document explains how the image URL transformation system works to handle image references in layout JSON files for both development and production environments.

## Problem

Layout JSON files contain hardcoded relative paths like `/sites/interventions-hub/src/assets/24/device-mobile.svg` that work in development but break in production because assets are bundled differently.

## Solution

The image URL transformation system automatically converts these relative paths to Vite-processed URLs that work in both environments.

### How It Works

1. **Asset Mapping**: A comprehensive mapping of all asset paths to their Vite-processed URLs is maintained in `src/utils/imageUrlTransformer.ts`
2. **Automatic Transformation**: When layouts are loaded, shared, or saved, image URLs are automatically transformed
3. **Fallback Handling**: If a mapping isn't found, the original URL is preserved (works in development, warns in production)

### Integration Points

The transformation is integrated at key points in the admin system:

- **Flow Library Loading** (`src/admin/Modals/FlowLibraryModal.tsx`)
- **URL Sharing** (`src/admin/hooks/useUrlSharing.ts`)
- **Multi-Layout URL Sharing** (`src/admin/hooks/useMultiUrlSharing.ts`)
- **Local Storage** (`src/admin/hooks/useLocalStorage.ts`)
- **Multi-Layout Data** (`src/admin/hooks/useMultiLayoutData.ts`)

### Asset Mapping Generation

The asset mapping is automatically generated by scanning the assets directory:

```bash
npm run generate-assets
```

This script:
1. Scans `src/assets/` for all image files
2. Creates import statements for each asset
3. Builds a mapping from expected paths to Vite-processed URLs
4. Updates `src/utils/imageUrlTransformer.ts`

### Usage

The transformation happens automatically, but you can also use it manually:

```typescript
import { transformImageUrl, transformLayoutImageUrls } from 'src/utils/imageUrlTransformer';

// Transform a single URL
const transformedUrl = transformImageUrl('/sites/interventions-hub/src/assets/24/device-mobile.svg');

// Transform all URLs in a layout
const transformedLayout = transformLayoutImageUrls(layoutData);
```

### Adding New Assets

When you add new assets that need to be referenced in layouts:

1. Add the asset to the appropriate directory in `src/assets/`
2. Run `npm run generate-assets` to update the mapping
3. The new asset will automatically be available for transformation

### Supported Asset Types

- **Icons**: 16px, 24px, 32px SVGs
- **Navigation Icons**: SVGs in `navigation/` directory
- **Avatar Images**: JPG, JPEG, PNG files in `avatars/` directory

### Example Transformation

**Input (from layout JSON):**
```json
{
  "left": {
    "type": "CELL_ICON",
    "icon": "/sites/interventions-hub/src/assets/24/device-mobile.svg"
  }
}
```

**Output (after transformation):**
```json
{
  "left": {
    "type": "CELL_ICON",
    "icon": "/sites/interventions-hub/assets/device-mobile-abc123.svg"
  }
}
```

### Benefits

- **Development**: Works seamlessly with existing relative paths
- **Production**: Assets are properly bundled and referenced
- **Maintainability**: Automatic generation keeps mappings up-to-date
- **Performance**: Only imports assets that are actually used
- **Flexibility**: Easy to add new asset types and directories

### Troubleshooting

If you see console warnings about missing asset mappings:

1. Run `npm run generate-assets` to update the mapping
2. Check that the asset file exists in the expected location
3. Verify the path in the layout JSON matches the expected pattern

### Future Enhancements

- Support for additional asset types (webp, avif, etc.)
- Dynamic asset discovery without script regeneration
- Asset optimization and compression
- CDN integration for production assets
